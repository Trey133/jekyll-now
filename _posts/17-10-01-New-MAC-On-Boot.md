---
layout: post
title: New-MAC-On-Boot
---
<p>I ran into a problem a few months ago with macchanger on Kali Linux. The problem<br />
was that I could manually change my MAC address with macchanger but it would automatically<br />
change back to my real MAC address everytime I connected to a network I had connected to before.</p>
<p>After doing a little research I figured out that the MAC address I had used to connect<br />
to a network in the past, was stored in a file called system-connections and was being called <br />
on by network-manager everytime I reconnected.</p>
<p>Now I had to find a way to change the MAC address specified in this file to the random MAC<br />
that was generated by macchanger.<br />
<p>In this tutorial we will be creating a python program and a bash script that we will create later on,<br />
to change the MAC address defined by our system-connections files. <br />
It is recommended that you have a little bit of programming or scripting experience before completing<br />
this tutorial although it is not required. I will attempt to explain everything that is going<br />
on so you can understand exactly what it is your system is doing when the MAC address is changed.</p>
<h3 style="text-align: left">Prerequisites</h3>
<p align="left">For this tutorial you will need to have:
<ul>
<li>A PC Running Kali Linux2.0</li><br /><br />
<li>Python2.7  <sup>apt-get install python2.7</sup></li><br /><br />
<li>macchanger  <sup>apt-get install macchanger</sup></li><br /><br />
</ul>
</p>
<h3>Let's Get Started!</h3>
<p>We are going to be creating 2 different files in this tutorial. One to control the networking devices and<br />
to change the mac address, and one to write the new mac address to the system-connections files. I am<br />
fairly certain that you don't have to do this with 2 different scripts. You could probably get the job done just<br />
as well with one, but this worked very well for me so this is the way I will show you today.</p>
<p>We will start with the python program since it is the longer of the two. Open your text editor and type<br />
this at the top of the page:<br />
<em>#!/usr/bin/env python</em><br />
<figure>
<a href="http://programthirteen.com/images/python-std-header.png">
        <img src="http://programthirteen.com/images/python-std-header.png" alt="" height="500px" width="750px"/>
    </a>
</figure>
<p>Now that we have our header, let's go ahead and import a few things:<br />
import subprocess<br />
import time</p>
<figure>
<a href="http://programthirteen.com/images/imports.png">
        <img src="http://programthirteen.com/images/imports.png" alt="" height="500px" width="750px"/>
    </a>
</figure>
<p>We are going to wrap everything in a try except statement in case something goes wrong when our program runs.<br />
The first thing we want our program to do is to bring down the network interfaces and we can do that with subprocess.</p>
<figure>
<a href="http://programthirteen.com/images/dis-inter.png">
        <img src="http://programthirteen.com/images/dis-inter.png" alt="" height="500px" width="750px"/>
    </a>
</figure>  
<p>You can see that I brought down both my Eth0 and Wlan0 interfaces.<br />
This is not neccessary for our program to run but, since I am already changing one MAC address, I like to go ahead and<br />
change them both, even if I don't plan on using my Eth0 interface at the moment.<br />
The wireless interface you use for your standard WiFi connections MUST be listed for this program to work correctly.</p>
<p>The next step in our program is going to be to actually change the MAC addresses of our interface(s).<br />
We will be using subprocess in our python program to call on macchanger. Macchanger is what handles the actual MAC<br />
address changes, not subprocess.</p>
<figure>
<a href="http://programthirteen.com/images/macchange.png">
        <img src="http://programthirteen.com/images/macchange.png" alt="" height="500px" width="750px"/>
    </a>
</figure>
<p>Now that we have changed our MAC address, let's make our program sleep for a second to ensure that<br />
macchanger has had time to make the changes to the system. Do this by adding the 'time.sleep' function on the next line.</p>
<p>time.sleep(1)</p>
<p>We put a '1' in the parenthesis to specify that the program should wait for 1 second before continuing. If you<br />
have a slower system, you may need to increase this a bit if you start to have issues with your programs timing.</p>
<p>For the next portion of our project, we are going to create a new file, so save your python program as 'nmac'.<br />
Open a new file in your editor. This file is going to write our new mac address to the system-connections files.<br />
<p>Now, this script is going to be a bash file so we will have a slightly different header.</p>
<p><em>#!/bin/sh</em></p>
<p>The first thing we need to do, is to get the new MAC address provided my macchanger. Your MAC address is stored<br />
in '/sys/class/net/wlan0/address' so we can get the address with our bash script like this:</p>
<figure>
<a href="http://programthirteen.com/images/getnewmac.png">
        <img src="http://programthirteen.com/images/getnewmac.png" alt="" height="500px" width="750px"/>
    </a>
</figure>
<p>Now that our script has our new MAC address, we are going to be using 'sed' to write our new MAC to the system-connections files.<br />
Your system-connections files should be located at '/etc/NetworkManager/system-connections/'. The more connections<br />
your system has made to other networks, the more files you will have stored in this directory.</p>
<p>Pick one of your system-connections files at random and open it.<br/>
It doesn't matter which one, just make sure its a network you've connected to via WiFi.<br />
I'll pick the Public Library for my example.</p>
<figure>
<a href="http://programthirteen.com/images/sysconfile.png">
        <img src="http://programthirteen.com/images/sysconfile.png" alt="" height="500px" width="750px"/>
    </a>
</figure>
<p>Find the line labeled 'mac-address='<br />
This is the line we are going to change in every one of our system-connection files.</p>
<p>Go back to your bash script and enter the following sed command on the next line.</p>
<figure>
<a href="http://programthirteen.com/images/sedcom.png">
        <img src="http://programthirteen.com/images/sedcom.png" alt="" height="500px" width="750px"/>
    </a>
</figure>
<p>This command will modify the line labled 'mac-address' in every one of our system-connection files.<br />
It looks a little confusing so let's take a look at what this command is actually doing.<br />
Let's start with "s#^mac-address=.*#mac-address=$MAC#g". This portion of the command is telling sed to look<br />
for the line 'mac-address=' and replace the text that follows that line with our new MAC address {$MAC}.<br />
The '-i' in our command is used to specify the file(s) that sed should modify. We added an asterisc after the trailing<br />
backspace to tell sed that we want it to check all the files in the directory 'system-connections' {/etc/NetworkManager/system-connections/*}.</p>
<p>Now let's tell our program to wait for a few seconds so the system can register the changes to the files, then we<br />
will print a message to the screen telling us that our script is finished running.</p>
<figure>
<a href="http://programthirteen.com/images/endscript.png">
        <img src="http://programthirteen.com/images/endscript.png" alt="" height="500px" width="750px"/>
    </a>
</figure>
<p>Save your new bash script as 'nmsed'. Then let's go back to our python program to finish that up.</p>
<p>We left off by telling our program to wait for '1' second before continuing. We will need to tell our program <br />
to run our new script next so that our MAC address will be written to the system-connections files. We will do this<br />
by again using the call method of subproccess. Then we will tell our program to wait for '1' more second. We are doing<br />
this to make sure the system has had time to register all the changes we just made. Removing this waiting period can<br />
and more than likely will break your program unless you have a very fast system and or very few system-connections</p>
<figure>
<a href="http://programthirteen.com/images/runnmsed.png">
        <img src="http://programthirteen.com/images/runnmsed.png" alt="" height="500px" width="750px"/>
    </a>
</figure>
<p>We will need to tell our program to raise the system interfaces after the MAC address has been changed. We will do<br />
this the same way we lowered the interfaces earlier, but change 'down' to 'up'.</p>
<figure>
<a href="http://programthirteen.com/images/intup.png">
        <img src="http://programthirteen.com/images/intup.png" alt="" height="500px" width="750px"/>
    </a>
</figure>
<p>Now let's have our program tell us what our new MAC address is.<br />
Do this with the 'check_output' method of subprocess. Then just use 'print' to print it to the screen</p>
<figure>
<a href="http://programthirteen.com/images/prntmac.png">
        <img src="http://programthirteen.com/images/prntmac.png" alt="" height="500px" width="750px"/>
    </a>
</figure>
<p>Now let's have our program wait a couple second so the user has time to see their new MAC address before the program terminates.<br />
Then we will add our exception clause so the program will tell us when and what errors occur.</p>
<figure>
<a href="http://programthirteen.com/images/progend.png">
        <img src="http://programthirteen.com/images/progend.png" alt="" height="500px" width="750px"/>
    </a>
</figure>
<p>That's it!!! Save your program as 'nmac' and add execute permissions with 'chmod +x nmac'. You will
need to add execute permissions to your 'nmsed' script as well. This can be done the same way. Now run<br />
your program with './nmac'.</p>
<figure>
<a href="http://programthirteen.com/images/run.png">
        <img src="http://programthirteen.com/images/run.png" alt="" height="500px" width="750px"/>
    </a>
</figure> 
<p>Check your system-connections file again and see if the MAC addresses have changed.</p>
<figure>
<a href="http://programthirteen.com/images/itworks.png">
        <img src="http://programthirteen.com/images/itworks.png" alt="" height="500px" width="750px"/>
    </a>
</figure>
<h4>IT WORKS!!!</h4>
<p>Go to your main menu (usually top or bottom left) > Settings > Session and Startup > Application Autostart<br />
Add your program by hitting the '+ Add' button at the bottom of the list. Your program should now start every time<br />
you log in to your system.</p>
<p align="left">Author: 73RM1N41@Program13</p>
